var SvgPiece=Class.create({initialize:function(a){this.size=a;this.paas=[]},add:function(a){this.paas.push(a)},toSet:function(b,a){var c=b.set();this.paas.forEach(function(d){var g=d.path;var e=Raphael.transformPath(g,a);var f=b.path(e);f.attr(d.attr);c.push(f)});return c}});var ConfigTmpl=Class.create({initialize:function(){this.tuples={};this.tuplist=[]},add:function(a){Utils.checkEquals(a,ConfigTmpl.fullSet);if(!(ConfigTmpl.types.hasOwnProperty(a.type))){throw"bad type ["+a.type+"]"}if(this.tuples.hasOwnProperty(a.name)){throw"repeat of key ["+a.name+"]"}this.tuples[a.name]=a;this.tuplist.push(a)},check:function(b,c){if(!(this.tuples.hasOwnProperty(b))){throw"wrong key ["+b+"]"}var d=this.tuples[b].type;var a=ConfigTmpl.types[d];Utils.checkType(c,a)},hasKey:function(a){return this.tuples.hasOwnProperty(a)},getDefaultValue:function(a){return this.tuples[a].defaultValue},getHTML:function(){var a="";a+="<table border='1'>";a+="<tr>";a+="<td>name</td>";a+="<td>type</td>";a+="<td>required</td>";a+="<td>description</td>";a+="<td>defaultValue</td>";a+="</tr>";this.tuplist.forEach(function(b){a+="<tr>";a+="<td>"+b.name+"</td>";a+="<td>"+b.type+"</td>";a+="<td>"+b.required+"</td>";a+="<td>"+b.description+"</td>";a+="<td>"+b.defaultValue+"</td>";a+="</tr>"});a+="</table>";return a}});ConfigTmpl.fullSet={name:undefined,type:undefined,required:undefined,description:undefined,defaultValue:undefined};ConfigTmpl.types={t_string:"string",t_number:"number",t_boolean:"boolean"};var Config=Class.create({initialize:function(a){this.d={};this.tmpl=a},getValue:function(a){if(this.tmpl.hasKey(a)){if(this.d[a]!==undefined){return this.d[a]}return this.tmpl.getDefaultValue(a)}throw"request for bad key ["+a+"]"},setValue:function(a,b){this.tmpl.check(a,b);this.d[a]=b},override:function(b){var a;for(a in b){this.setValue(a,b[a])}},check:function(){return}});var SvgPieceData=Class.create({initialize:function(b,a){this.set=b;this.pixelPos=a;this.extra=undefined},toString:function(){return[this.set,this.pixelPos,this.extra].join()},forEach:function(a){this.set.forEach(function(b){a(b)});if(this.extra!==undefined){this.extra.forEach(function(b){a(b)})}}});var Board=Class.create({initialize:function(){var c,b,a;this.bd=[];for(c=0;c<8;c++){a=[];for(b=0;b<8;b++){a.push(undefined)}this.bd.push(a)}this.pieces=[];this.preAddCB=[];this.postAddCB=[];this.preRemoveCB=[];this.postRemoveCB=[];this.preMoveCB=[];this.postMoveCB=[]},toString:function(){var b,a;var c="";for(b=0;b<8;b++){for(a=0;a<8;a++){c+=this.bd[b][a]}c+="\n"}return c},checkNoPieceAt:function(a){if(this.bd[a.x][a.y]!==undefined){throw"already have piece at position "+a.toString()}},checkPieceAt:function(a){if(this.bd[a.x][a.y]===undefined){throw"dont have piece at position "+a.toString()}},checkBoardPieceAt:function(a,b){if(this.bd[b.x][b.y]!==a){throw"wrong piece at position "+b.toString()}},addPiece:function(a,b){this.preAddCB.forEach(function(c){c(a,b)});this.checkNoPieceAt(b);this.bd[b.x][b.y]=a;this.postAddCB.forEach(function(c){c(a,b)})},removePiece:function(a,b){this.checkBoardPieceAt(a,b);this.preRemoveCB.forEach(function(c){c(a,b)});this.bd[b.x][b.y]=undefined;this.postRemoveCB.forEach(function(c){c(a,b)})},movePiece:function(b,c,a){this.checkPieceAt(c);this.checkNoPieceAt(a);this.preMoveCB.forEach(function(d){d(b,c,a)});this.bd[c.x][c.y]=undefined;this.bd[a.x][a.y]=b;this.postMoveCB.forEach(function(d){d(b,c,a)})},clearPieces:function(){var a=this;this.forEachPiece(function(b,c){a.removePiece(b,c)})},addPieceVals:function(b,d,a,e){var c=new BoardPiece(new PieceColor(b),new PieceType(d));this.addPiece(c,new PiecePosition(a,e))},forEachPiece:function(c){var b,a;for(b=0;b<8;b++){for(a=0;a<8;a++){if(this.bd[b][a]!==undefined){c(this.bd[b][a],new PiecePosition(b,a))}}}},getPieceAtPosition:function(a){this.checkPieceAt(a);return this.bd[a.x][a.y]},getPieceAtPositionVals:function(a,b){return this.getPieceAtPosition(new PiecePosition(a,b))},hasPieceAtPosition:function(a){return this.bd[a.x][a.y]!==undefined},hasPieceAtPositionVals:function(a,b){return this.hasPieceAtPosition(new PiecePosition(a,b))},addPiecePostAddCallback:function(a){this.postAddCB.push(a)},addPiecePostRemoveCallback:function(a){this.postRemoveCB.push(a)},addPiecePostMoveCallback:function(a){this.postMoveCB.push(a)},setPosition:function(a){this.clearPieces();var b=this;a.forEachPiece(function(c,d){b.addPiece(c,d)})},startPosition:function(){this.setPosition(BoardPosition.startPos())},movePieceByPos:function(c,a){var b=this.getPieceAtPosition(c);this.movePiece(b,c,a)},getPiecePosition:function(c){var b,a;for(b=0;b<8;b++){for(a=0;a<8;a++){if(this.bd[b][a]===c){return new PiecePosition(b,a)}}}throw"piece not on board "+c}});function Chess(){}function Ajax(){}function Raphael(){}function Class(){}function $(){}var PieceType=Class.create({initialize:function(a){if(!(PieceType.types.hasOwnProperty(a))){throw"illegal piecetype "+a}this.type=a},toString:function(){return this.type},isRook:function(){return this.type==="rook"},isKnight:function(){return this.type==="knight"},isBishop:function(){return this.type==="bishop"},isQueen:function(){return this.type==="queen"},isKing:function(){return this.type==="king"},isPawn:function(){return this.type==="pawn"}});PieceType.types={rook:undefined,knight:undefined,bishop:undefined,queen:undefined,king:undefined,pawn:undefined};var SvgCreator=Class.create({initialize:function(){return}});SvgCreator.createPiece=function(b,d,f){var c=b.getValue("size")/240;var e={"stroke-width":c,stroke:b.getValue("pencolor"),"stroke-linejoin":"round","stroke-linecap":"round"};var a;if(d.isWhite()){if(b.getValue("gradients")){e.fill="0-#fff:0-#fff:50-#999:100"}else{e.fill=b.getValue("white_color")}if(f.isRook()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 9,39 L 36,39 L 36,36 L 9,36 L 9,39 z",e));a.add(new SvgPathAndAttributes("M 12,36 L 12,32 L 33,32 L 33,36 L 12,36 z",e));a.add(new SvgPathAndAttributes("M 11,14 L 11,9 L 15,9 L 15,11 L 20,11 L 20,9 L 25,9 L 25,11 L 30,11 L 30,9 L 34,9 L 34,14",e));a.add(new SvgPathAndAttributes("M 34,14 L 31,17 L 14,17 L 11,14",e));a.add(new SvgPathAndAttributes("M 31,17 L 31,29.5 L 14,29.5 L 14,17",e));a.add(new SvgPathAndAttributes("M 31,29.5 L 32.5,32 L 12.5,32 L 14,29.5",e));a.add(new SvgPathAndAttributes("M 11,14 L 34,14",e));return a}if(f.isKnight()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 22,10 C 32.5,11 38.5,18 38,39 L 15,39 C 15,30 25,32.5 23,18 24,18 C 24.38,20.91 18.45,25.37 16,27 C 13,29 13.18,31.34 11,31 C 9.958,30.06 12.41,27.96 11,28 C 10,28 11.19,29.23 10,30 C 9,30 5.997,31 6,26 C 6,24 12,14 12,14 C 12,14 13.89,12.1 14,10.5 C 13.27,9.506 13.5,8.5 13.5,7.5 C 14.5,6.5 16.5,10 16.5,10 L 18.5,10 C 18.5,10 19.28,8.008 21,7 C 22,7 22,10 22,10",e));a.add(new SvgPathAndAttributes("M 9.5 25.5 A 0.5 0.5 0 1 1 8.5,25.5 A 0.5 0.5 0 1 1 9.5 25.5 z",e));a.add(new SvgPathAndAttributes("M 15 15.5 A 0.5 1.5 0 1 1 14,15.5 A 0.5 1.5 0 1 1 15 15.5 z",e));return a}if(f.isBishop()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 9,36 C 12.39,35.03 19.11,36.43 22.5,34 C 25.89,36.43 32.61,35.03 36,36 C 36,36 37.65,36.54 39,38 C 38.32,38.97 37.35,38.99 36,38.5 C 32.61,37.53 25.89,38.96 22.5,37.5 C 19.11,38.96 12.39,37.53 9,38.5 C 7.646,38.99 6.677,38.97 6,38 C 7.354,36.06 9,36 9,36 z",e));a.add(new SvgPathAndAttributes("M 15,32 C 17.5,34.5 27.5,34.5 30,32 C 30.5,30.5 30,30 30,30 C 30,27.5 27.5,26 27.5,26 C 33,24.5 33.5,14.5 22.5,10.5 C 11.5,14.5 12,24.5 17.5,26 C 17.5,26 15,27.5 15,30 C 15,30 14.5,30.5 15,32 z",e));a.add(new SvgPathAndAttributes("M 25 8 A 2.5 2.5 0 1 1 20,8 A 2.5 2.5 0 1 1 25 8 z",e));a.add(new SvgPathAndAttributes("M 17.5,26 L 27.5,26 M 15,30 L 30,30 M 22.5,15.5 L 22.5,20.5 M 20,18 L 25,18",e));return a}if(f.isQueen()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M8,12C8,13.539600717839003,6.333333333333333,14.501851166488377,5,13.732050807568877C4.381197846482994,13.374785217660714,4,12.714531179816328,4,12C4,10.460399282160997,5.666666666666667,9.498148833511623,7,10.267949192431123C7.618802153517006,10.625214782339286,8,11.285468820183672,8,12C8,12,8,12,8,12",e));a.add(new SvgPathAndAttributes("M24.5,7.5C24.5,9.039600717839003,22.833333333333332,10.001851166488377,21.5,9.232050807568877C20.881197846482994,8.874785217660714,20.5,8.214531179816328,20.5,7.5C20.5,5.9603992821609975,22.166666666666668,4.998148833511623,23.5,5.767949192431123C24.118802153517006,6.125214782339286,24.5,6.785468820183672,24.5,7.5C24.5,7.5,24.5,7.5,24.5,7.5",e));a.add(new SvgPathAndAttributes("M41,12C41,13.539600717839003,39.333333333333336,14.501851166488377,38,13.732050807568877C37.38119784648299,13.374785217660714,37,12.714531179816328,37,12C37,10.460399282160997,38.666666666666664,9.498148833511623,40,10.267949192431123C40.61880215351701,10.625214782339286,41,11.285468820183672,41,12C41,12,41,12,41,12",e));a.add(new SvgPathAndAttributes("M16,8.5C16,10.039600717839003,14.333333333333332,11.001851166488377,13,10.232050807568877C12.381197846482994,9.874785217660714,12,9.214531179816328,12,8.5C12,6.9603992821609975,13.666666666666668,5.998148833511623,15,6.767949192431123C15.618802153517006,7.125214782339286,16,7.785468820183672,16,8.5C16,8.5,16,8.5,16,8.5",e));a.add(new SvgPathAndAttributes("M33,9C33,10.539600717839003,31.333333333333332,11.501851166488377,30,10.732050807568877C29.381197846482994,10.374785217660714,29,9.714531179816328,29,9C29,7.4603992821609975,30.666666666666668,6.498148833511623,32,7.267949192431123C32.61880215351701,7.625214782339286,33,8.285468820183672,33,9C33,9,33,9,33,9",e));a.add(new SvgPathAndAttributes("M 9,26 C 17.5,24.5 30,24.5 36,26 L 38,14 L 31,25 L 31,11 L 25.5,24.5 L 22.5,9.5 L 19.5,24.5 L 14,10.5 L 14,25 L 7,14 L 9,26 z",e));a.add(new SvgPathAndAttributes("M 9,26 C 9,28 10.5,28 11.5,30 C 12.5,31.5 12.5,31 12,33.5 C 10.5,34.5 10.5,36 10.5,36 C 9,37.5 11,38.5 11,38.5 C 17.5,39.5 27.5,39.5 34,38.5 C 34,38.5 35.5,37.5 34,36 C 34,36 34.5,34.5 33,33.5 C 32.5,31 32.5,31.5 33.5,30 C 34.5,28 36,28 36,26 C 27.5,24.5 17.5,24.5 9,26 z",e));a.add(new SvgPathAndAttributes("M 11.5,30 C 15,29 30,29 33.5,30",e));a.add(new SvgPathAndAttributes("M 12,33.5 C 18,32.5 27,32.5 33,33.5",e));return a}if(f.isKing()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 22.5,11.63 L 22.5,6",e));a.add(new SvgPathAndAttributes("M 20,8 L 25,8",e));a.add(new SvgPathAndAttributes("M 22.5,25 C 22.5,25 27,17.5 25.5,14.5 C 25.5,14.5 24.5,12 22.5,12 C 20.5,12 19.5,14.5 19.5,14.5 C 18,17.5 22.5,25 22.5,25",e));a.add(new SvgPathAndAttributes("M 11.5,37 C 17,40.5 27,40.5 32.5,37 L 32.5,30 C 32.5,30 41.5,25.5 38.5,19.5 C 34.5,13 25,16 22.5,23.5 L 22.5,27 L 22.5,23.5 C 19,16 9.5,13 6.5,19.5 C 3.5,25.5 11.5,29.5 11.5,29.5 L 11.5,37 z",e));a.add(new SvgPathAndAttributes("M 11.5,30 C 17,27 27,27 32.5,30",e));a.add(new SvgPathAndAttributes("M 11.5,33.5 C 17,30.5 27,30.5 32.5,33.5",e));a.add(new SvgPathAndAttributes("M 11.5,37 C 17,34 27,34 32.5,37",e));return a}if(f.isPawn()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 22,9 C 19.79,9 18,10.79 18,13 C 18,13.89 18.29,14.71 18.78,15.38 C 16.83,16.5 15.5,18.59 15.5,21 C 15.5,23.03 16.44,24.84 17.91,26.03 C 14.91,27.09 10.5,31.58 10.5,39.5 L 33.5,39.5 C 33.5,31.58 29.09,27.09 26.09,26.03 C 27.56,24.84 28.5,23.03 28.5,21 C 28.5,18.59 27.17,16.5 25.22,15.38 C 25.71,14.71 26,13.89 26,13 C 26,10.79 24.21,9 22,9 z",e));return a}}if(d.isBlack()){if(b.getValue("gradients")){e.fill="0-#555:0-#222:50-#000:100"}else{e.fill=b.getValue("black_color")}if(f.isRook()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 9,39 L 36,39 L 36,36 L 9,36 L 9,39 z",e));a.add(new SvgPathAndAttributes("M 12.5,32 L 14,29.5 L 31,29.5 L 32.5,32 L 12.5,32 z",e));a.add(new SvgPathAndAttributes("M 12,36 L 12,32 L 33,32 L 33,36 L 12,36 z",e));a.add(new SvgPathAndAttributes("M 14,29.5 L 14,16.5 L 31,16.5 L 31,29.5 L 14,29.5 z",e));a.add(new SvgPathAndAttributes("M 14,16.5 L 11,14 L 34,14 L 31,16.5 L 14,16.5 z",e));a.add(new SvgPathAndAttributes("M 11,14 L 11,9 L 15,9 L 15,11 L 20,11 L 20,9 L 25,9 L 25,11 L 30,11 L 30,9 L 34,9 L 34,14 L 11,14 z",e));e=Utils.clone(e);e.stroke="#fff";a.add(new SvgPathAndAttributes("M 12,35.5 L 33,35.5",e));a.add(new SvgPathAndAttributes("M 13,31.5 L 32,31.5",e));a.add(new SvgPathAndAttributes("M 14,29.5 L 31,29.5",e));a.add(new SvgPathAndAttributes("M 14,16.5 L 31,16.5",e));a.add(new SvgPathAndAttributes("M 11,14 L 34,14",e));return a}if(f.isKnight()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 22,10 C 32.5,11 38.5,18 38,39 L 15,39 C 15,30 25,32.5 23,18",e));a.add(new SvgPathAndAttributes("M 24,18 C 24.38,20.91 18.45,25.37 16,27 C 13,29 13.18,31.34 11,31 C 9.958,30.06 12.41,27.96 11,28 C 10,28 11.19,29.23 10,30 C 9,30 5.997,31 6,26 C 6,24 12,14 12,14 C 12,14 13.89,12.1 14,10.5 C 13.27,9.506 13.5,8.5 13.5,7.5 C 14.5,6.5 16.5,10 16.5,10 L 18.5,10 C 18.5,10 19.28,8.008 21,7 C 22,7 22,10 22,10",e));e=Utils.clone(e);e.fill="#fff";e.stroke="#fff";a.add(new SvgPathAndAttributes("M 9.5 25.5 A 0.5 0.5 0 1 1 8.5,25.5 A 0.5 0.5 0 1 1 9.5 25.5 z",e));a.add(new SvgPathAndAttributes("M 15 15.5 A 0.5 1.5 0 1 1 14,15.5 A 0.5 1.5 0 1 1 15 15.5 z",e));e=Utils.clone(e);e.fill="#fff";e.stroke="none";a.add(new SvgPathAndAttributes("M 24.55,10.4 L 24.1,11.85 L 24.6,12 C 27.75,13 30.25,14.49 32.5,18.75 C 34.75,23.01 35.75,29.06 35.25,39 L 35.2,39.5 L 37.45,39.5 L 37.5,39 C 38,28.94 36.62,22.15 34.25,17.66 C 31.88,13.17 28.46,11.02 25.06,10.5 L 24.55,10.4 z",e));return a}if(f.isBishop()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 9,36 C 12.39,35.03 19.11,36.43 22.5,34 C 25.89,36.43 32.61,35.03 36,36 C 36,36 37.65,36.54 39,38 C 38.32,38.97 37.35,38.99 36,38.5 C 32.61,37.53 25.89,38.96 22.5,37.5 C 19.11,38.96 12.39,37.53 9,38.5 C 7.646,38.99 6.677,38.97 6,38 C 7.354,36.06 9,36 9,36 z",e));a.add(new SvgPathAndAttributes("M 15,32 C 17.5,34.5 27.5,34.5 30,32 C 30.5,30.5 30,30 30,30 C 30,27.5 27.5,26 27.5,26 C 33,24.5 33.5,14.5 22.5,10.5 C 11.5,14.5 12,24.5 17.5,26 C 17.5,26 15,27.5 15,30 C 15,30 14.5,30.5 15,32 z",e));a.add(new SvgPathAndAttributes("M 25 8 A 2.5 2.5 0 1 1 20,8 A 2.5 2.5 0 1 1 25 8 z",e));e=Utils.clone(e);e.stroke="#fff";a.add(new SvgPathAndAttributes("M 17.5,26 L 27.5,26 M 15,30 L 30,30 M 22.5,15.5 L 22.5,20.5 M 20,18 L 25,18",e));return a}if(f.isQueen()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M8,12C8,13.539600717839003,6.333333333333333,14.501851166488377,5,13.732050807568877C4.381197846482994,13.374785217660714,4,12.714531179816328,4,12C4,10.460399282160997,5.666666666666667,9.498148833511623,7,10.267949192431123C7.618802153517006,10.625214782339286,8,11.285468820183672,8,12C8,12,8,12,8,12",e));a.add(new SvgPathAndAttributes("M24.5,7.5C24.5,9.039600717839003,22.833333333333332,10.001851166488377,21.5,9.232050807568877C20.881197846482994,8.874785217660714,20.5,8.214531179816328,20.5,7.5C20.5,5.9603992821609975,22.166666666666668,4.998148833511623,23.5,5.767949192431123C24.118802153517006,6.125214782339286,24.5,6.785468820183672,24.5,7.5C24.5,7.5,24.5,7.5,24.5,7.5",e));a.add(new SvgPathAndAttributes("M41,12C41,13.539600717839003,39.333333333333336,14.501851166488377,38,13.732050807568877C37.38119784648299,13.374785217660714,37,12.714531179816328,37,12C37,10.460399282160997,38.666666666666664,9.498148833511623,40,10.267949192431123C40.61880215351701,10.625214782339286,41,11.285468820183672,41,12C41,12,41,12,41,12",e));a.add(new SvgPathAndAttributes("M16,8.5C16,10.039600717839003,14.333333333333332,11.001851166488377,13,10.232050807568877C12.381197846482994,9.874785217660714,12,9.214531179816328,12,8.5C12,6.9603992821609975,13.666666666666668,5.998148833511623,15,6.767949192431123C15.618802153517006,7.125214782339286,16,7.785468820183672,16,8.5C16,8.5,16,8.5,16,8.5",e));a.add(new SvgPathAndAttributes("M33,9C33,10.539600717839003,31.333333333333332,11.501851166488377,30,10.732050807568877C29.381197846482994,10.374785217660714,29,9.714531179816328,29,9C29,7.4603992821609975,30.666666666666668,6.498148833511623,32,7.267949192431123C32.61880215351701,7.625214782339286,33,8.285468820183672,33,9C33,9,33,9,33,9",e));a.add(new SvgPathAndAttributes("M 9,26 C 17.5,24.5 30,24.5 36,26 L 38.5,13.5 L 31,25 L 30.7,10.9 L 25.5,24.5 L 22.5,10 L 19.5,24.5 L 14.3,10.9 L 14,25 L 6.5,13.5 L 9,26 z",e));a.add(new SvgPathAndAttributes("M 9,26 C 9,28 10.5,28 11.5,30 C 12.5,31.5 12.5,31 12,33.5 C 10.5,34.5 10.5,36 10.5,36 C 9,37.5 11,38.5 11,38.5 C 17.5,39.5 27.5,39.5 34,38.5 C 34,38.5 35.5,37.5 34,36 C 34,36 34.5,34.5 33,33.5 C 32.5,31 32.5,31.5 33.5,30 C 34.5,28 36,28 36,26 C 27.5,24.5 17.5,24.5 9,26 z",e));a.add(new SvgPathAndAttributes("M 11,38.5 A 35,35 1 0 0 34,38.5",e));e=Utils.clone(e);e.stroke="#fff";a.add(new SvgPathAndAttributes("M 11,29 A 35,35 1 0 1 34,29",e));a.add(new SvgPathAndAttributes("M 12.5,31.5 L 32.5,31.5",e));a.add(new SvgPathAndAttributes("M 11.5,34.5 A 35,35 1 0 0 33.5,34.5",e));a.add(new SvgPathAndAttributes("M 10.5,37.5 A 35,35 1 0 0 34.5,37.5",e));return a}if(f.isKing()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 22.5,11.63 L 22.5,6",e));a.add(new SvgPathAndAttributes("M 22.5,25 C 22.5,25 27,17.5 25.5,14.5 C 25.5,14.5 24.5,12 22.5,12 C 20.5,12 19.5,14.5 19.5,14.5 C 18,17.5 22.5,25 22.5,25",e));a.add(new SvgPathAndAttributes("M 11.5,37 C 17,40.5 27,40.5 32.5,37 L 32.5,30 C 32.5,30 41.5,25.5 38.5,19.5 C 34.5,13 25,16 22.5,23.5 L 22.5,27 L 22.5,23.5 C 19,16 9.5,13 6.5,19.5 C 3.5,25.5 11.5,29.5 11.5,29.5 L 11.5,37 z",e));a.add(new SvgPathAndAttributes("M 20,8 L 25,8",e));e=Utils.clone(e);e.stroke="#fff";a.add(new SvgPathAndAttributes("M 32,29.5 C 32,29.5 40.5,25.5 38.03,19.85 C 34.15,14 25,18 22.5,24.5 L 22.51,26.6 L 22.5,24.5 C 20,18 9.906,14 6.997,19.85 C 4.5,25.5 11.85,28.85 11.85,28.85",e));a.add(new SvgPathAndAttributes("M 11.5,30 C 17,27 27,27 32.5,30 M 11.5,33.5 C 17,30.5 27,30.5 32.5,33.5 M 11.5,37 C 17,34 27,34 32.5,37",e));return a}if(f.isPawn()){a=new SvgPiece(45);a.add(new SvgPathAndAttributes("M 22,9 C 19.79,9 18,10.79 18,13 C 18,13.89 18.29,14.71 18.78,15.38 C 16.83,16.5 15.5,18.59 15.5,21 C 15.5,23.03 16.44,24.84 17.91,26.03 C 14.91,27.09 10.5,31.58 10.5,39.5 L 33.5,39.5 C 33.5,31.58 29.09,27.09 26.09,26.03 C 27.56,24.84 28.5,23.03 28.5,21 C 28.5,18.59 27.17,16.5 25.22,15.38 C 25.71,14.71 26,13.89 26,13 C 26,10.79 24.21,9 22,9 z",e));return a}}throw"unknown piece "+f};var SvgBoard=Class.create({initialize:function(b,d){this.config=new Config(SvgConfigTmpl.getInstance());this.config.override(d);this.config.check();this.boardview=this.getValue("boardview");this.size=this.getValue("size");if(this.getValue("do_letters")){var a=this.getValue("partial");this.square=this.getValue("size")/(8+a);this.offX=this.square*(a/2);this.offY=this.square*(a/2)}else{this.square=this.getValue("size")/8;this.offX=0;this.offY=0}this.board=b;this.raphaelPrep();this.drawBoard();if(this.getValue("do_letters")){this.drawBorder()}var c=this;this.board.addPiecePostAddCallback(function(e,f){c.postAddPiece(e,f)});this.board.addPiecePostRemoveCallback(function(e,f){c.postRemovePiece(e,f)});this.board.addPiecePostMoveCallback(function(f,e,g){c.postMovePiece(f,e,g)});this.overlay();this.glow_obj={};this.glow_obj.width=this.getValue("glow_width");this.glow_obj.fill=this.getValue("glow_fill");this.glow_obj.opacity=this.getValue("glow_opacity");this.glow_obj.offsetx=this.getValue("glow_offsetx");this.glow_obj.offsety=this.getValue("glow_offsety");this.glow_obj.color=this.getValue("glow_color");this.lastPos=undefined;this.currentPos=undefined;this.selectedPiece=undefined;this.selectedRec=undefined},getBoard:function(){return this.board},getValue:function(a){return this.config.getValue(a)},raphaelPrep:function(){this.paper=new WRaphael(this.getValue("id"),this.getValue("size"),this.getValue("size"));this.elem=$(this.getValue("id"));var a=this.elem.cumulativeOffset();this.startX=a.left;this.startY=a.top},rectFill:function(f,d){var c=f.data("pos");var b;if(this.boardview==="white"||this.boardview==="black"){b=1}else{b=0}var e;if((c.x+c.y)%2===b){if(this.getValue("gradients")){e=this.getValue("white_square_gradient")}else{e=this.getValue("white_square_color")}}else{if(this.getValue("gradients")){e=this.getValue("black_square_gradient")}else{e=this.getValue("black_square_color")}}if(d){if(this.getValue("gradients")){f.attr("fill",e)}else{var a=this.getValue("move_ms");f.animate({fill:e},a)}}else{f.attr("fill",e)}},drawBorder:function(){var b,h,g,e,c,a;var f=0.5;var d=this.getValue("partial");this.texts=[];for(h=0;h<8;h++){g=this.paper.text(this.square*(d/2)*f,(h+0.5)*this.square+this.offY,8-h);this.texts.push(g);e=this.paper.text(this.offX+this.square*8+this.square*(d/2)*f,(h+0.5)*this.square+this.offY,8-h);this.texts.push(e)}for(b=0;b<8;b++){c=this.paper.text((b+0.5)*this.square+this.offX,this.square*(d/2)*f,String.fromCharCode(b+"A".charCodeAt(0)));this.texts.push(c);a=this.paper.text((b+0.5)*this.square+this.offX,this.offY+this.square*8+this.square*(d/2)*f,String.fromCharCode(b+"A".charCodeAt(0)));this.texts.push(a)}},translatePos:function(a){if(this.boardview==="white"){return new PiecePosition(a.x,a.y)}if(this.boardview==="black"){return new PiecePosition(7-a.x,7-a.y)}if(this.boardview==="left"){return new PiecePosition(a.y,a.x)}if(this.boardview==="right"){return new PiecePosition(7-a.y,7-a.x)}throw"boardview is not correct"},drawBoard:function(){var a,h,b,g,c;var d=this;var e=function(i,f,j){return function(){var k=d.translatePos(i);d.eventPosition(k,f,j)}};this.recs=[];for(a=0;a<8;a++){b=[];for(h=0;h<8;h++){g=this.paper.rect(a*this.square+this.offX,h*this.square+this.offY,this.square,this.square);g.attr({stroke:this.getValue("rec_stroke_color"),"stroke-width":this.getValue("rec_stroke_width")});b.push(g);c=new PiecePosition(a,7-h);g.data("pos",c);this.rectFill(g,false);g.click(e(c,g,"click"));g.mousedown(e(c,g,"mousedown"));g.mouseout(e(c,g,"mouseout"));g.mouseover(e(c,g,"mouseover"));g.mouseup(e(c,g,"mouseup"))}b.reverse();this.recs.push(b)}},overlay:function(){if(this.getValue("do_select_global")){var a=this;var c=0;var b=this.paper.rect(this.offX+c,this.offY+c,this.square*8-c,this.square*8-c);b.attr({fill:Raphael.getColor()});b.attr({opacity:0});b.mouseover(function(e,d,f){a.eventGlobal(e,d-a.startX-a.offX,f-a.startY-a.offY,"mouseover")});b.mouseout(function(e,d,f){a.eventGlobal(e,d-a.startX-a.offX,f-a.startY-a.offY,"mouseout")});b.toFront();this.fullRec=b}},postGraphics:function(){if(this.getValue("do_select_global")){this.fullRec.toFront()}},postAddPiece:function(b,g){var f=this;var h=SvgCreator.createPiece(this.config,b.color,b.type);var e=this.posToPixels(g);var d=Raphael.matrix();d.translate(e.x+this.offX,e.y+this.offY);d.scale(this.square/h.size,this.square/h.size);var c=d.toTransformString();var i=h.toSet(this.paper,c);i.eventRegister((function(j){return function(k){f.eventPiece(j,k)}}(b)),["click","mouseover","mouseout"]);var a=new SvgPieceData(i,e);b.setData(a);this.postGraphics()},postRemovePiece:function(b,c){Utils.fakeUse(c);var a=b.getData();a.set.remove();b.unsetData()},posToPixels:function(a){if(this.boardview==="white"){return new SvgPixelPosition(a.x*this.square,(7-a.y)*this.square)}if(this.boardview==="black"){return new SvgPixelPosition((7-a.x)*this.square,a.y*this.square)}if(this.boardview==="left"){return new SvgPixelPosition(a.y*this.square,(7-a.x)*this.square)}if(this.boardview==="right"){return new SvgPixelPosition((7-a.y)*this.square,a.x*this.square)}throw"boardview is bad"},pixelsToPos:function(b){var a=Math.floor((b.x)/this.square);var c=Math.floor((b.y)/this.square);if(this.boardview==="white"){return new PiecePosition(a,7-c)}if(this.boardview==="black"){return new PiecePosition(7-a,c)}if(this.boardview==="left"){return new PiecePosition(c,7-a)}if(this.boardview==="right"){return new PiecePosition(7-c,a)}throw"boardview is bad"},pixelsToPosForgiving:function(b){var a=Math.floor((b.x)/this.square);var c=Math.floor((b.y)/this.square);if(a>7||a<0||c>7||c<0){return undefined}if(this.boardview==="white"){return new PiecePosition(a,7-c)}if(this.boardview==="black"){return new PiecePosition(7-a,c)}if(this.boardview==="left"){return new PiecePosition(c,7-a)}if(this.boardview==="right"){return new PiecePosition(7-c,a)}throw"boardview is bad"},resize:function(c){var a=Raphael.matrix();a.scale(1.7,1.7);var b=a.toTransformString();c.forEach(function(d){d.transform(b)},this)},showHidePiece:function(b,a){var c=b.getData();c.forEach(function(d){if(a){d.hide()}else{d.show()}})},showPiece:function(a){this.showHidePiece(a,false)},hidePiece:function(a){this.showHidePiece(a,true)},postMovePiece:function(b,c,a){this.timeMovePiece(b,c,a)},timeMovePiece:function(c,e,b){Utils.fakeUse(e);var a=this.getValue("move_ms");var f=c.getData().pixelPos;var d=this.posToPixels(b);c.getData().forEach(function(i){var g=Raphael.matrix();g.translate(d.x-f.x,d.y-f.y);var h=g.toTransformString();i.animate({transform:h},a)})},flip:function(){var a=this.boardview;switch(this.boardview){case"white":this.boardview="black";break;case"black":this.boardview="white";break;case"left":this.boardview="right";break;case"right":this.boardview="left";break;default:throw"boardview is bad"}this.redraw(a)},rotateright:function(){var a=this.boardview;if(!(SvgBoard.ObjRotateRight.hasOwnProperty(a))){throw"boardview is bad"}this.boardview=SvgBoard.ObjRotateRight[this.boardview];this.redraw(a)},rotateleft:function(){var a=this.boardview;if(!(SvgBoard.ObjRotateLeft.hasOwnProperty(a))){throw"boardview is bad"}this.boardview=SvgBoard.ObjRotateLeft[this.boardview];this.redraw(a)},toString:function(){throw"not yet implemented"},glow:function(b,c){var a=b.getData();if(c){a.extra=a.set.glow(this.glow_obj)}else{a.extra.remove();a.extra=undefined}},redraw:function(c){var a,d;Utils.fakeUse(c);var b=this;this.board.forEachPiece(function(f,e){b.timeMovePiece(f,e,e)});for(a=0;a<8;a++){for(d=0;d<8;d++){this.rectFill(this.getRec(new PiecePosition(a,d)),true)}}},eventPiece:function(a,c){if(this.getValue("do_select_piecerec")){if(c==="mouseover"){var b=this.board.getPiecePosition(a);if(this.currentPos===undefined||b.notEqual(this.currentPos)){this.lastPos=this.currentPos;this.currentPos=b;this.newPosition()}}}},eventPosition:function(b,c,a){if(this.getValue("do_select_piecerec")){if(a==="mouseover"){this.lastPos=this.currentPos;this.currentPos=b;this.newPosition()}if(a==="mouseout"){this.lastPos=this.currentPos;this.currentPos=undefined;this.newPosition()}}if(this.getValue("do_select_click")){if(a==="click"){if(this.selected){if(this.selected===c){this.rectFill(this.selected,false);this.selected=undefined}else{this.rectFill(this.selected,false);c.attr("fill",this.getValue("select_color"));this.selected=c}}else{c.attr("fill",this.getValue("select_color"));this.selected=c}}}},eventGlobal:function(d,a,e,c){Utils.fakeUse(d);if(this.getValue("do_select_global")){if(c==="mouseover"||c==="mousemove"){var b=this.pixelsToPosForgiving(new SvgPixelPosition(a,e));if(b!==undefined){if(this.currentPos===undefined){this.lastPos=undefined;this.currentPos=b;this.newPosition()}else{if(b.notEqual(this.currentPos)){this.lastPos=this.currentPos;this.currentPos=b;this.newPosition()}}}else{Utils.pass()}}if(c==="mouseout"){this.lastPos=this.currentPos;this.currentPos=undefined;this.newPosition()}}if(this.getValue("do_select_piecerec")){if(c==="mouseout"){this.lastPos=this.currentPos;this.currentPos=undefined;this.newPosition()}}},newPosition:function(){if(this.currentPos===undefined){if(this.selectedPiece!==undefined){if(this.getValue("do_select_piece")){this.glow(this.selectedPiece,false);this.selectedPiece=undefined}}if(this.selectedRec!==undefined){if(this.getValue("do_select_square")){this.rectFill(this.selectedRec,false);this.selectedRec=undefined}}}else{if(this.board.hasPieceAtPosition(this.currentPos)){var a=this.board.getPieceAtPosition(this.currentPos);if(this.getValue("do_select_piece")){if(this.selectedPiece===undefined){this.selectedPiece=a;this.glow(this.selectedPiece,true)}else{this.glow(this.selectedPiece,false);this.selectedPiece=a;this.glow(this.selectedPiece,true)}}}else{if(this.selectedPiece!==undefined){if(this.getValue("do_select_piece")){this.glow(this.selectedPiece,false);this.selectedPiece=undefined}}}if(this.getValue("do_select_square")){var b=this.getRec(this.currentPos);if(this.selectedRec===undefined){this.selectedRec=b;this.selectedRec.attr("fill",this.getValue("over_color"))}else{this.rectFill(this.selectedRec,false);this.selectedRec=b;this.selectedRec.attr("fill",this.getValue("over_color"))}}}},getRec:function(a){if(this.boardview==="white"){return this.recs[a.x][a.y]}if(this.boardview==="black"){return this.recs[7-a.x][7-a.y]}if(this.boardview==="left"){return this.recs[a.y][a.x]}if(this.boardview==="right"){return this.recs[7-a.y][7-a.x]}throw"boardview is bad"}});SvgBoard.ObjRotateRight={white:"left",left:"black",black:"right",right:"white"};SvgBoard.ObjRotateLeft={white:"right",right:"black",black:"left",left:"white"};var BoardPosition=Class.create({initialize:function(){this.pieces=[]},toString:function(){return this.pieces.join()},addPiece:function(b,e,a,f){var c=new BoardPiece(new PieceColor(b),new PieceType(e));var d=new PiecePosition(a,f);this.pieces.push([c,d])},forEachPiece:function(a){this.pieces.forEach(function(d){var c=d[0];var b=d[1];a(c,b)})}});BoardPosition.startPos=function(){return BoardPosition.setupFEN("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")};BoardPosition.setupFEN=function(b){var a,d,h,e;var g=b.split(" ");if(g.length!==6){throw"parse error - number of blocks is not 6"}var f=g[0].split("/");if(f.length!==8){throw"parse error - number of ranks is not 8"}var c=new BoardPosition();for(a=7;a>=0;a--){h=f[7-a];for(d=0;d<h.length;d++){e=h[d];switch(e){case"r":c.addPiece("black","rook",d,a);break;case"R":c.addPiece("white","rook",d,a);break;case"n":c.addPiece("black","knight",d,a);break;case"N":c.addPiece("white","knight",d,a);break;case"b":c.addPiece("black","bishop",d,a);break;case"B":c.addPiece("white","bishop",d,a);break;case"q":c.addPiece("black","queen",d,a);break;case"Q":c.addPiece("white","queen",d,a);break;case"k":c.addPiece("black","king",d,a);break;case"K":c.addPiece("white","king",d,a);break;case"p":c.addPiece("black","pawn",d,a);break;case"P":c.addPiece("white","pawn",d,a);break;default:d+=Number(e)-1;break}}}return c};var Utils=Class.create({initialize:function(){return}});Utils.unite=function(d,c){var b={};var a,e;for(a in d){b[a]=d[a]}for(e in c){b[e]=c[e]}return b};Utils.clone=function(c){var b={};var a;for(a in c){b[a]=c[a]}return b};Utils.fakeUse=function(){if(Utils.nottrue){window.junkVar="junkVal"}};Utils.pass=function(){return};Utils.arrClone=function(b){return b.slice()};Utils.getType=function(a){return typeof a};Utils.checkType=function(a,b){if(Utils.getType(a)!==b){throw"type is wrong"}};Utils.checkContains=function(c,b){var a;for(a in c){if(!(b.hasOwnProperty(a))){throw"key "+a+" is bad"}}};Utils.checkEquals=function(b,a){Utils.checkContains(b,a);Utils.checkContains(a,b)};var PiecePosition=Class.create({initialize:function(a,b){Utils.checkType(a,"number");Utils.checkType(b,"number");if(a<0||a>7){throw"bad value for x "+a+","+typeof a}if(b<0||b>7){throw"bad value for y "+b+","+typeof b}this.x=a;this.y=b},toString:function(){return"PiecePosition: ("+this.x+","+this.y+")"},notEqual:function(a){if(!(a instanceof PiecePosition)){throw"bad type passed"}return a.x!==this.x||a.y!==this.y},equal:function(a){if(!(a instanceof PiecePosition)){throw"bad type passed"}return a.x===this.x&&a.y===this.y}});var SvgPathAndAttributes=Class.create({initialize:function(b,a){this.path=b;this.attr=a},toString:function(){return[this.path,this.attr].join()}});var WSet=Class.create({initialize:function(b,a){this.set=b;this.wrapper=a},push:function(){var a=this.set.push;var b=a.apply(this.set,arguments);return b},remove:function(){var a=this.set.remove;var b=a.apply(this.set,arguments);return b},forEach:function(){var a=this.set.forEach;var b=a.apply(this.set,arguments);return b},glow:function(a){var b=this.wrapper.set();this.forEach(function(c){b.push(c.glow(a))},undefined);return b},eventRegister:function(b,c){var a=this;c.forEach(function(d){a.forEach(function(f){switch(d){case"click":f.click(function(){b(d)});break;case"mouseover":f.mouseover(function(){b(d)});break;case"mouseout":f.mouseout(function(){b(d)});break;case"mousemove":f.mousemove(function(){b(d)});break;case"mouseup":f.mouseup(function(){b(d)});break;case"mousedown":f.mousedown(function(){b(d)});break;default:throw"unknown event name "+d}})})}});var WRaphael=Class.create({initialize:function(){this.r=Raphael.apply(undefined,arguments)},rect:function(){var a=this.r.rect;var b=a.apply(this.r,arguments);return b},set:function(){var a=this.r.set;var b=a.apply(this.r,arguments);return new WSet(b,this)},path:function(){var a=this.r.path;var b=a.apply(this.r,arguments);return b},text:function(){var a=this.r.text;var b=a.apply(this.r,arguments);return b}});var Controls=Class.create({initialize:function(a){this.id=a.id;this.b_goto_start=new Element("button").update("goto_start");this.b_prev_move=new Element("button").update("prev_move");this.b_prev_play=new Element("button").update("prev_play");this.b_next_play=new Element("button").update("next_play");this.b_next_move=new Element("button").update("next_move");this.b_goto_end=new Element("button").update("goto_end");$(this.id).appendChild(this.b_goto_start);$(this.id).appendChild(this.b_prev_move);$(this.id).appendChild(this.b_prev_play);$(this.id).appendChild(this.b_next_play);$(this.id).appendChild(this.b_next_move);$(this.id).appendChild(this.b_goto_end)},toString:function(){return"no toString for type Controls"}});var SvgPixelPosition=Class.create({initialize:function(a,b){this.x=a;this.y=b},toString:function(){return"("+this.x+","+this.y+")"}});var Game=Class.create({initialize:function(){return},toString:function(){return"no toString for type Game"}});var GameMove=Class.create({initialize:function(){return},toString:function(){return"no toString for type GameMove"}});var PieceColor=Class.create({initialize:function(a){if(!(PieceColor.colors.hasOwnProperty(a))){throw"illegal piecetype "+a}this.color=a},toString:function(){return this.color},isWhite:function(){return this.color==="white"},isBlack:function(){return this.color==="black"}});PieceColor.colors={white:undefined,black:undefined};goog.provide("$");goog.provide("Ajax");goog.provide("Chess");goog.provide("Class");goog.provide("Raphael");goog.require("$");goog.require("Ajax");goog.require("Chess");goog.require("Class");goog.require("Raphael");var PgnReader=Class.create({initialize:function(){return},toString:function(){throw"toString for PgnReader not implemented yet"},get:function(a){var b=new Ajax.Request(a,{method:"get",onSuccess:function(e){var c=e.responseText;var d=new Chess();d.load_pgn(c);console.log(d.history({verbose:true}))},onFailure:function(c){console.log("error in transport for url "+a);console.dir(c)}});Utils.fakeUse(b)}});var BoardPiece=Class.create({initialize:function(a,b){this.color=a;this.type=b;this.data=undefined},toString:function(){return"BoardPiece: "+[this.color,this.type,this.data].join()},setData:function(a){this.data=a},getData:function(){return this.data},unsetData:function(){this.data=undefined}});var SvgConfigTmpl=Class.create(ConfigTmpl,{initialize:function($super){$super();this.add({name:"id",type:"t_string",required:true,description:"id where to place the board",defaultValue:undefined});this.add({name:"size",type:"t_number",required:false,description:"size of the board",defaultValue:500});this.add({name:"black_color",type:"t_string",required:false,description:"color of the black pieces",defaultValue:"#000000"});this.add({name:"white_color",type:"t_string",required:false,description:"color of the white pieces",defaultValue:"#ffffff"});this.add({name:"black_square_color",type:"t_string",required:false,description:"color of the black squares",defaultValue:"#819faa"});this.add({name:"white_square_color",type:"t_string",required:false,description:"color of the white squares",defaultValue:"#ffffff"});this.add({name:"black_square_gradient",type:"t_string",required:false,description:"gradient for black squares",defaultValue:"0-#91afba:0-#819faa:50-#819faa:100"});this.add({name:"white_square_gradient",type:"t_string",required:false,description:"gradient for white squares",defaultValue:"0-#eee:0-#fff:50-#fff:100"});this.add({name:"boardview",type:"t_string",required:false,description:"what board view to use",defaultValue:"white"});this.add({name:"move_ms",type:"t_number",required:false,description:"ms for moving animation",defaultValue:350});this.add({name:"flip_ms",type:"t_number",required:false,description:"how fast should flip work in ms",defaultValue:350});this.add({name:"pencolor",type:"t_string",required:false,description:"pen color for drawing the shapes",defaultValue:"black"});this.add({name:"gradients",type:"t_boolean",required:false,description:"should we use gradients?",defaultValue:true});this.add({name:"select_color",type:"t_string",required:false,description:"color of selected squares",defaultValue:"#ffff00"});this.add({name:"over_color",type:"t_string",required:false,description:"color of selected squares",defaultValue:"#00ff00"});this.add({name:"do_select_click",type:"t_boolean",required:false,description:"should we select clicks",defaultValue:false});this.add({name:"do_select_square",type:"t_boolean",required:false,description:"should we select squares",defaultValue:true});this.add({name:"do_select_piece",type:"t_boolean",required:false,description:"should we select pieces",defaultValue:true});this.add({name:"do_select_global",type:"t_boolean",required:false,description:"should we select pieces via the global variables",defaultValue:false});this.add({name:"do_select_piecerec",type:"t_boolean",required:false,description:"should we select pieces via the global variables",defaultValue:false});this.add({name:"do_letters",type:"t_boolean",required:false,description:"draw letters around the board",defaultValue:true});this.add({name:"rec_stroke_color",type:"t_string",required:false,description:"rectangles stroke color",defaultValue:"black"});this.add({name:"rec_stroke_width",type:"t_number",required:false,description:"rectangles stroke width",defaultValue:0.1});this.add({name:"glow_width",type:"t_number",required:false,description:"glow width",defaultValue:7});this.add({name:"glow_fill",type:"t_boolean",required:false,description:"glow fill",defaultValue:false});this.add({name:"glow_opacity",type:"t_number",required:false,description:"glow opacity",defaultValue:0.5});this.add({name:"glow_offsetx",type:"t_number",required:false,description:"glow offsetx",defaultValue:0});this.add({name:"glow_offsety",type:"t_number",required:false,description:"glow offsety",defaultValue:0});this.add({name:"glow_color",type:"t_string",required:false,description:"glow color",defaultValue:"black"});this.add({name:"partial",type:"t_number",required:false,description:"how many squares for borders",defaultValue:0.6})}});SvgConfigTmpl.instance=undefined;SvgConfigTmpl.getInstance=function(){if(SvgConfigTmpl.instance===undefined){SvgConfigTmpl.instance=new SvgConfigTmpl()}return SvgConfigTmpl.instance};var SvgControls=Class.create({initialize:function(a){Utils.pass(a)}});